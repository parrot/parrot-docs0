<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Multimethod dispatch for binary opcode functions</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Multimethod dispatch for binary opcode functions</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../html/index.html">Contents</a> | <a href="../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>src/mmd.c &#45; Multimethod dispatch for binary opcode functions</p>

<h1><a name="SYNOPSIS"
>SYNOPSIS <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>This system is set up to handle type&#45;based dispatching for binary (i.e.
two&#45;arg) functions.
This includes,
though isn&#39;t necessarily limited to,
binary operators such as addition or subtraction.</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>The MMD system is straightforward,
and currently must be explicitly invoked,
for example by a vtable function.
(We may reserve the right to use MMD in all circumstances,
but currently do not).</p>

<h2><a name="API"
>API <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>For the purposes of the API,
each MMD&#45;able function is assigned a unique number which is used to find the correct function table.
This is the <code lang='und' xml:lang='und'>func_num</code> parameter in the following functions.
While Parrot isn&#39;t restricted to a predefined set of functions,
it <i>does</i> set things up so that all the binary vtable functions have a MMD table preinstalled for them,
with default behaviour.</p>

<h2><a name="Remarks"
>Remarks <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p><code lang='und' xml:lang='und'>binop_mmd_funcs&#45;&#62;x</code> and <code lang='und' xml:lang='und'>&#45;&#62;y</code> are table sizes not highest type in table.</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a
><b><code lang='und' xml:lang='und'>void mmd_dispatch_v_ppp(Interp *interpreter, PMC *left, PMC *right, PMC *dest, INTVAL function)</b></code></a></dt><p class="pad"></p>

<dd>Dispatch to a multimethod that &#34;returns&#34; a PMC.
<code lang='und' xml:lang='und'>left</code>,
<code lang='und' xml:lang='und'>right</code>,
and <code lang='und' xml:lang='und'>dest</code> are all PMC pointers,
while <code lang='und' xml:lang='und'>func_num</code> is the MMD table that should be used to do the dispatching.</dd><p class="pad"></p>

<dd>The MMD system will figure out which function should be called based on the types of <code lang='und' xml:lang='und'>left</code> and <code lang='und' xml:lang='und'>right</code> and call it,
passing in <code lang='und' xml:lang='und'>left</code>,
<code lang='und' xml:lang='und'>right</code>,
and <code lang='und' xml:lang='und'>dest</code> like any other binary vtable function.</dd><p class="pad"></p>

<dd>This function has a <code lang='und' xml:lang='und'>void</code> return type,
like all the &#34;take two PMCs,
return a PMC&#34; vtable functions do.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>void mmd_dispatch_v_pip(Interp *interpreter, PMC *left, INTVAL right, PMC *dest, INTVAL function)</b></code></a></dt><p class="pad"></p>

<dd>Like above,
right argument is a native INTVAL.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>void mmd_dispatch_v_pnp(Interp *interpreter, PMC *left, FLOATVAL right, PMC *dest, INTVAL function)</b></code></a></dt><p class="pad"></p>

<dd>Like above,
right argument is a native FLOATVAL.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>void mmd_dispatch_v_psp(Interp *interpreter, PMC *left, STRING *right, PMC *dest, INTVAL function)</b></code></a></dt><p class="pad"></p>

<dd>Like above,
right argument is a native STRING *.</dd><p class="pad"></p>

<dt><a name="INTVAL_mmd_dispatch_i_pp(Interp_*interpreter,_PMC_*left,_PMC_*right,_INTVAL_function)"
><b><code lang='und' xml:lang='und'>INTVAL mmd_dispatch_i_pp(Interp *interpreter, PMC *left, PMC *right, INTVAL function)</b></code></a></dt><p class="pad"></p>

<dd>Like <code lang='und' xml:lang='und'>mmd_dispatch_v_ppp()</code>,
only it returns an <code lang='und' xml:lang='und'>INTVAL</code>.</dd><p class="pad"></p>

<dt><a name="void_mmd_add_function(Interp_*interpreter,_INTVAL_funcnum,_funcptr_t_function)"
><b><code lang='und' xml:lang='und'>void mmd_add_function(Interp *interpreter, INTVAL funcnum, funcptr_t function)</b></code></a></dt><p class="pad"></p>

<dd>Add a new binary MMD function to the list of functions the MMD system knows of.
<code lang='und' xml:lang='und'>func_num</code> is the number of the new function,
while <code lang='und' xml:lang='und'>default_func</code> is the function to be called when the system doesn&#39;t know which function it should call.
(Because,
for example,
there hasn&#39;t been a function installed that matches the left and right types for a call).</dd><p class="pad"></p>

<dt><a name="static_void_mmd_expand_x(Interp_*interpreter,_INTVAL_function,_INTVAL_new_x)"
><b><code lang='und' xml:lang='und'>static void mmd_expand_x(Interp *interpreter, INTVAL function, INTVAL new_x)</b></code></a></dt><p class="pad"></p>

<dd>Expands the function table in the X dimension to include <code lang='und' xml:lang='und'>new_x</code>.</dd><p class="pad"></p>

<dt><a name="static_void_mmd_expand_y(Interp_*interpreter,_INTVAL_function,_INTVAL_new_y)"
><b><code lang='und' xml:lang='und'>static void mmd_expand_y(Interp *interpreter, INTVAL function, INTVAL new_y)</b></code></a></dt><p class="pad"></p>

<dd>Expands the function table in the Y direction.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>void mmd_add_by_class(Interp *interpreter, INTVAL functype, STRING *left_class, STRING *right_class, funcptr_t funcptr)</b></code></a></dt><p class="pad"></p>

<dd>Add a function to the MMD table by class name,
rather than class number.
Handles the case where the named class isn&#39;t loaded yet.</dd><p class="pad"></p>

<dd>Adds a new MMD function <code lang='und' xml:lang='und'>funcptr</code> to the <code lang='und' xml:lang='und'>func_num</code> function table that will be invoked when the left parameter is of class <code lang='und' xml:lang='und'>left_class</code> and the right parameter is of class <code lang='und' xml:lang='und'>right_class</code>.
Both classes are <code lang='und' xml:lang='und'>STRING *</code>s that hold the PMC class names for the left and right sides.
If either class isn&#39;t yet loaded,
Parrot will cache the information such that the function will be installed if at some point in the future both classes are available.</dd><p class="pad"></p>

<dd>Currently this is done by just assigning class numbers to the classes,
which the classes will pick up and use if they&#39;re later loaded,
but we may later put the functions into a deferred table that we scan when PMC classes are loaded.
Either way,
the function will be guaranteed to be installed when it&#39;s needed.</dd><p class="pad"></p>

<dd>The function table must exist,
but if it is too small,
it will automatically be expanded.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>void mmd_register(Interp *interpreter, INTVAL type, INTVAL left_type, INTVAL right_type, funcptr_t funcptr)</b></code></a></dt><p class="pad"></p>

<dd>Register a function <code lang='und' xml:lang='und'>funcptr</code> for MMD function table <code lang='und' xml:lang='und'>func_num</code> for classes <code lang='und' xml:lang='und'>left_type</code> and <code lang='und' xml:lang='und'>right_type</code>.
The left and right types are <code lang='und' xml:lang='und'>INTVAL</code>s that represent the class ID numbers.</dd><p class="pad"></p>

<dd>The function table must exist,
but if it is too small,
it will automatically be expanded.</dd><p class="pad"></p>

<dd>Adding a new function to the table can be interestingly non&#45;trivial,
so we get to be tricky.</dd><p class="pad"></p>

<dd>If the left or right types are larger than anything we&#39;ve seen so far,
it means that we have to expand the table.
Making Y larger is simple &#45;&#45; just realloc with some more rows.
Making X larger is less simple.
In either case,
we punt to other functions.</dd><p class="pad"></p>

<dd>TODO &#45; Currently the MMD system doesn&#39;t handle inheritance and best match searching,
as it assumes that all PMC types have no parent type.
This can be considered a bug,
and will be resolved at some point in the future.</dd><p class="pad"></p>

<dt><a name="void_mmd_destroy(Parrot_Interp_interpreter)"
><b><code lang='und' xml:lang='und'>void mmd_destroy(Parrot_Interp interpreter)</b></code></a></dt><p class="pad"></p>

<dd>Frees all the memory allocated used the MMD subsystem.</dd><p class="pad"></p>

<dt><a name="PMC_*_mmd_vtfind(Parrot_Interp_interpreter,_INTVAL_type,_INTVAL_left,_INTVAL_right)"
><b><code lang='und' xml:lang='und'>PMC *mmd_vtfind(Parrot_Interp interpreter, INTVAL type, INTVAL left, INTVAL right)</b></code></a></dt><p class="pad"></p>

<dd>Return an MMD PMC function for the given data types.
The return result is either a Sub PMC (for PASM MMD functions) or a CSub PMC holding the C function pointer in PMC_struct_val.
This CSub is not invocable,
you have to wrap it into an NCI function to get the required function arguments passed.</dd><p class="pad"></p>
</dl>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'>include/parrot/mmd.h</em>.</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
